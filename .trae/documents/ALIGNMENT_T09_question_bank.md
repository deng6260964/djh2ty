# T09题库管理API - 对齐文档 (ALIGNMENT)

## 1. 项目上下文分析

### 1.1 现有项目结构

基于对现有项目的分析，英语家教管理系统已完成以下核心模块：

- **T05**: 用户认证系统 - JWT认证、会话管理、权限控制
- **T06**: 用户管理系统 - 用户CRUD、角色管理、权限验证
- **T07**: 课程管理系统 - 课程CRUD、选课管理、权限控制
- **T08**: 作业管理系统 - 作业CRUD、文件上传、提交批改、统计功能

### 1.2 现有技术架构

**后端架构**：
- Flask + SQLAlchemy + JWT认证
- 蓝图模块化架构（`app/routes/`目录）
- 统一的数据库模型设计（`app/models/`目录）
- 基于角色的权限控制系统
- 统一的异常处理和响应格式

**数据模型现状**：
- 已存在 `Question` 和 `QuestionBank` 模型（`app/models/question.py`）
- 支持多种题型：选择题、判断题、填空题、主观题、听力题、口语题
- 支持难度分级：初级、中级、高级
- 支持题库分类和标签系统
- 支持音频和图片文件关联

**缺失组件**：
- 题库管理API路由（`app/routes/questions.py`）
- 题库相关的单元测试
- 随机抽题算法实现
- 试卷生成功能
- 题库导入导出功能

### 1.3 现有代码模式分析

通过分析T06-T08的实现模式，发现以下统一规范：

1. **路由结构**：使用Flask蓝图，统一的RESTful API设计
2. **权限控制**：`@jwt_required()` + 角色验证
3. **数据验证**：请求数据验证和错误处理
4. **响应格式**：统一的JSON响应格式
5. **测试覆盖**：完整的单元测试用例

## 2. 原始需求分析

### 2.1 TASK文档需求

基于 `TASK_english_tutoring_system.md` 中T09的定义：

**输入契约**：
- 前置依赖：T06（用户管理API）
- 输入数据：题库管理需求
- 环境依赖：Flask, SQLAlchemy

**输出契约**：
- 题目 CRUD API
- 随机抽题 API
- 试卷生成 API
- 题库导入导出 API

**验收标准**：
- [ ] 题目管理功能正常
- [ ] 随机抽题算法正确
- [ ] 试卷生成功能正常
- [ ] 导入导出功能正常

### 2.2 业务需求细化

**题库管理需求**：
1. 题库CRUD：创建、查询、更新、删除题库
2. 题库权限：公开题库 vs 私有题库
3. 题库分类：语法、词汇、阅读、听力等

**题目管理需求**：
1. 题目CRUD：创建、查询、更新、删除题目
2. 多种题型支持：选择题、判断题、填空题、主观题等
3. 难度分级：初级、中级、高级
4. 标签系统：便于分类和检索
5. 媒体文件：支持音频、图片文件

**随机抽题需求**：
1. 按题库抽题
2. 按难度抽题
3. 按题型抽题
4. 按标签抽题
5. 避重复抽题

**试卷生成需求**：
1. 自定义试卷结构
2. 按比例分配题型和难度
3. 总分值控制
4. 试卷模板保存

**导入导出需求**：
1. 支持Excel格式导入导出
2. 支持JSON格式导入导出
3. 批量题目操作
4. 数据验证和错误处理

## 3. 边界确认

### 3.1 功能边界

**包含功能**：
- 题库和题目的完整CRUD操作
- 基于多维度的随机抽题算法
- 灵活的试卷生成功能
- 题库数据的导入导出
- 完整的权限控制和数据验证

**不包含功能**：
- 在线答题功能（属于T16前端页面）
- 自动评分系统（仅提供答案检查方法）
- 题目推荐算法（超出当前范围）
- 题目统计分析（可在后续版本添加）

### 3.2 技术边界

**技术约束**：
- 必须与现有Flask架构保持一致
- 复用现有的认证和权限系统
- 遵循现有的数据库设计模式
- 保持与T06-T08相同的代码风格

**性能边界**：
- 随机抽题响应时间 < 500ms
- 支持单次导入最多1000道题目
- 试卷生成时间 < 2秒

### 3.3 集成边界

**与现有系统集成**：
- 用户认证：复用T05的JWT认证
- 权限管理：复用T06的角色权限系统
- 文件管理：集成T10的文件上传功能（音频、图片）
- 课程关联：可与T07课程系统关联（可选）

## 4. 需求理解

### 4.1 核心业务流程

1. **题库管理流程**：
   - 教师创建题库 → 设置题库属性 → 添加题目 → 发布题库
   - 管理员审核公开题库 → 设置权限 → 维护题库

2. **题目管理流程**：
   - 创建题目 → 设置题型和难度 → 添加选项和答案 → 上传媒体文件 → 保存题目
   - 批量导入 → 数据验证 → 错误处理 → 成功导入

3. **抽题流程**：
   - 设置抽题条件 → 执行抽题算法 → 返回题目列表 → 避重复处理

4. **试卷生成流程**：
   - 定义试卷结构 → 按条件抽题 → 组装试卷 → 计算总分 → 生成试卷

### 4.2 数据模型理解

基于现有 `Question` 和 `QuestionBank` 模型：

**QuestionBank 模型特点**：
- 支持分类和难度分级
- 支持公开/私有权限控制
- 包含创建者信息和时间戳
- 提供题目数量统计方法

**Question 模型特点**：
- 支持6种题型（选择、判断、填空、主观、听力、口语）
- 支持3个难度等级
- 支持标签系统和媒体文件
- 提供答案检查方法
- 包含分值和激活状态

### 4.3 API设计理解

基于现有T06-T08的API设计模式：

**统一响应格式**：
```json
{
  "success": true/false,
  "data": {},
  "message": "操作结果描述",
  "error": "错误信息（如有）"
}
```

**统一权限控制**：
- 使用 `@jwt_required()` 装饰器
- 基于用户角色进行权限验证
- 支持资源所有者权限检查

**统一错误处理**：
- 参数验证错误：400 Bad Request
- 权限不足错误：403 Forbidden
- 资源不存在错误：404 Not Found
- 服务器错误：500 Internal Server Error

## 5. 疑问澄清

### 5.1 已解决疑问

基于现有项目分析，以下疑问已通过代码和文档得到解决：

1. **数据模型设计** ✅
   - 现有模型已完整定义，无需修改
   - 支持所需的所有题型和属性

2. **权限控制机制** ✅
   - 复用现有的JWT认证和角色权限系统
   - 支持题库的公开/私有权限控制

3. **文件上传集成** ✅
   - 可集成现有的文件管理系统
   - 支持音频和图片文件关联

### 5.2 需要确认的设计决策

1. **随机抽题算法策略**：
   - 采用加权随机算法，考虑题目难度和使用频率
   - 实现题目池管理，避免短期内重复抽取
   - 支持多维度组合抽题（难度+题型+标签）

2. **试卷生成策略**：
   - 支持模板化试卷生成
   - 实现智能题目分配算法
   - 支持试卷结构自定义（题型比例、分值分布）

3. **导入导出格式**：
   - 主要支持Excel格式（.xlsx）
   - 辅助支持JSON格式
   - 提供标准模板和格式说明

4. **性能优化策略**：
   - 题目查询使用数据库索引优化
   - 抽题结果缓存机制
   - 大批量操作的分页处理

### 5.3 技术实现决策

1. **API路由设计**：
   - 题库管理：`/api/question-banks/*`
   - 题目管理：`/api/questions/*`
   - 抽题功能：`/api/questions/random`
   - 试卷生成：`/api/question-banks/generate-paper`
   - 导入导出：`/api/question-banks/import`, `/api/question-banks/export`

2. **数据验证策略**：
   - 使用Flask-WTF进行表单验证
   - 自定义验证器处理业务规则
   - 统一的错误消息格式

3. **测试策略**：
   - 单元测试覆盖所有API接口
   - 集成测试验证业务流程
   - 性能测试验证抽题和生成效率

## 6. 最终确认

### 6.1 需求确认

✅ **功能需求明确**：题库CRUD、题目CRUD、随机抽题、试卷生成、导入导出
✅ **技术方案确定**：基于现有Flask架构，复用认证和权限系统
✅ **数据模型完整**：现有Question和QuestionBank模型满足需求
✅ **集成方案清晰**：与T05-T08系统无缝集成

### 6.2 实现边界确认

✅ **任务范围明确**：仅实现后端API，不包含前端页面
✅ **技术约束明确**：遵循现有架构和代码规范
✅ **性能要求明确**：响应时间和数据量限制
✅ **质量标准明确**：完整测试覆盖和文档

### 6.3 验收标准确认

✅ **功能验收**：所有API接口正常工作
✅ **性能验收**：满足响应时间要求
✅ **质量验收**：代码规范、测试覆盖、文档完整
✅ **集成验收**：与现有系统无冲突

## 7. 下一步行动

基于本对齐文档，下一步将进入 **Architect（架构阶段）**，生成：
- `DESIGN_T09_question_bank.md` - 详细的系统架构设计
- 包含API接口规范、数据流设计、算法设计等

---

**文档状态**: ✅ 对齐完成  
**创建时间**: 2024-01-16  
**最后更新**: 2024-01-16